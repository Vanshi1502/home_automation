#define BLYNK_TEMPLATE_ID "TMPL3NoeLHAuO"
#define BLYNK_TEMPLATE_NAME "Home automation"
#define BLYNK_AUTH_TOKEN "NGxHKZdMyK26w7YawzvVuf6K5Sjz2gw5"


#include <ESP8266WiFi.h>
#include <BlynkSimpleEsp8266.h>
#include <DHT.h>


// WiFi credentials
char ssid[] = "Kausi";
char pass[] = "88888888";


// Relay pins
#define RELAY1 D1  // GPIO5
#define RELAY2 D2  // GPIO4
#define RELAY3 D3  // GPIO0
#define RELAY4 D4  // GPIO2
#define FAN_RELAY D6  // GPIO12


// DHT11 setup
#define DHTPIN D5      // GPIO14
#define DHTTYPE DHT11


DHT dht(DHTPIN, DHTTYPE);
BlynkTimer timer;


// Variables
int tempThreshold = 30;   // default threshold


void sendSensor() {
  float temp = dht.readTemperature();
  float hum = dht.readHumidity();


  if (isnan(temp) || isnan(hum)) {
    return;
  }


  Blynk.virtualWrite(V7, temp);  // Send temperature to V7
  Blynk.virtualWrite(V8, hum);   // Send humidity to V8


  // Auto mode only: fan control by temperature
  if (temp >= tempThreshold) {
    digitalWrite(FAN_RELAY, LOW);  // Turn fan ON (active LOW)
  } else {
    digitalWrite(FAN_RELAY, HIGH); // Turn fan OFF
  }
}


void setup() {
  Serial.begin(9600);


  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);
  pinMode(RELAY4, OUTPUT);
  pinMode(FAN_RELAY, OUTPUT);


  digitalWrite(RELAY1, HIGH);
  digitalWrite(RELAY2, HIGH);
  digitalWrite(RELAY3, HIGH);
  digitalWrite(RELAY4, HIGH);
  digitalWrite(FAN_RELAY, HIGH);  // Fan OFF initially


  dht.begin();
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
  timer.setInterval(2000L, sendSensor);  // Every 2 sec
}


// Relay 1 control (V1)
BLYNK_WRITE(V1) {
  int value = param.asInt();
  digitalWrite(RELAY1, value ? LOW : HIGH);
}


// Relay 2 control (V2)
BLYNK_WRITE(V2) {
  int value = param.asInt();
  digitalWrite(RELAY2, value ? LOW : HIGH);
}


// Relay 3 control (V3)
BLYNK_WRITE(V3) {
  int value = param.asInt();
  digitalWrite(RELAY3, value ? LOW : HIGH);
}


// Relay 4 control (V4)
BLYNK_WRITE(V4) {
  int value = param.asInt();
  digitalWrite(RELAY4, value ? LOW : HIGH);
}


// Temperature threshold slider (V6)
BLYNK_WRITE(V6) {
  tempThreshold = param.asFloat();
}


void loop() {
  Blynk.run();
  timer.run();
}